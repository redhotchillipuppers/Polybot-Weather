================================================================================
POLYBOT-WEATHER REFACTORING TODO LIST
================================================================================

Generated: 2026-01-27
Last reviewed: 2026-01-28
Based on: Code review of entire codebase

Progress Summary:
  HIGH PRIORITY:    3/4 complete (75%)
  MEDIUM PRIORITY:  2/4 complete (50%)
  LOW PRIORITY:     1/4 complete (25%)
  OVERALL:          6/12 complete (50%)

================================================================================
HIGH PRIORITY
================================================================================

[x] 1. Add environment variable validation at startup

    COMPLETED: Created src/config/env.ts with validateEnv() function that:
    - Checks all required env vars (PRIVATE_KEY, OPENWEATHER_API_KEY) exist
    - Provides clear error messages listing missing variables
    - Exits with helpful example .env file format
    Updated both src/index.ts and src/monitor-markets.ts to use getEnvConfig().

--------------------------------------------------------------------------------

[x] 2. Consolidate hardcoded constants into config file

    COMPLETED: Created src/config/constants.ts with all magic numbers:
    - DECIDED_95_THRESHOLD (0.95)
    - DECIDED_95_STREAK_REQUIRED (2)
    - MARKET_CHECK_MINUTES ([0, 10, 20, 30, 40, 50])
    - WEATHER_CHECK_MINUTES ([0, 10, 20, 30, 40, 50])
    - EDGE_THRESHOLD (0.05)
    - MARKET_LOOKAHEAD_DAYS (3)
    - HOST (Polymarket CLOB URL)
    - CHAIN_ID (137)
    - GAMMA_API_URL (Polymarket Gamma API)
    - LONDON_LAT, LONDON_LON (coordinates)
    - OPENWEATHER_FORECAST_ENDPOINT
    Updated monitor-markets.ts, polymarket.ts, weather.ts, probability-model.ts,
    and positions/decided-95.ts to import from the centralized config file.

--------------------------------------------------------------------------------

[x] 3. Remove duplicate market API calls

    COMPLETED: Combined checkWeatherForecast() and checkMarketOdds() into
    a single runScheduledCheck() function that fetches markets once and
    shares the result for both weather date extraction and odds analysis.
    Changed from two separate schedulers to one combined scheduler.
    Updated src/monitor-markets.ts.

--------------------------------------------------------------------------------

[ ] 4. Weather Underground oracle monitor (EGLC)

    Polymarket resolves this market using the Weather Underground daily
    history page for London City Airport (EGLC):
    https://www.wunderground.com/history/daily/gb/london/EGLC

    Resolution uses the finalized daily high temperature, rounded to whole °C.
    Revisions after finalization are ignored.

    Implement an oracle monitor that:
    - Identifies the internal JSON endpoint used by the WU page
      (via DevTools -> Network -> Fetch/XHR, "Copy as cURL")
    - Calls that endpoint directly (no full browser) to read the daily high (°C)
    - Logs changes and stability of the reported "High" near end-of-day
    - Feeds this value into late-stage Polymarket decision logic
      (oracle-alignment signal)

================================================================================
MEDIUM PRIORITY
================================================================================

[ ] 5. Replace global mutable state with dependency injection

    Current global variables make testing impossible:
    - latestWeatherForecasts (line 36)
    - settledMarketIds (line 448)
    - positionsData (line 463)
    - previousMarketCount (line 1062)

    Create a MonitoringState class or use constructor injection to pass
    state explicitly to functions that need it.

--------------------------------------------------------------------------------

[ ] 6. Add TypeScript types for Polymarket API responses

    polymarket.ts uses 'any' extensively for API response handling.
    Define proper interfaces:
    - RawPolymarketMarket
    - RawPolymarketEvent
    - GammaApiResponse

    This will catch API changes at compile time rather than runtime.

--------------------------------------------------------------------------------

[x] 7. Write tests for critical business logic

    COMPLETED: Added comprehensive test suites for all critical business logic:
    - src/positions/decided-95.test.ts (28 tests): DECIDED_95 detection logic,
      extractDateKeyFromEndDate, isExactTemperatureMarket, streak tracking
    - src/positions/position-manager.test.ts (17 tests): Mark-to-market P&L
      calculations for YES/NO positions, edge cases, DECIDED_95 scenarios
    - src/settlement/settlement.test.ts (27 tests): Settlement P&L calculations
      (calculateTradePnl), null handling, symmetry verification
    - src/parsers/market-parser.test.ts (40 tests): parseMarketQuestion,
      extractTemperatureFromQuestion, extractDateFromQuestion, all month names
    Total: 112 new tests across 4 test files. Run with: npx tsx src/<path>.test.ts

--------------------------------------------------------------------------------

[x] 8. Clean up deprecated code

    COMPLETED: Removed the deprecated weatherForecast field from MonitoringEntry
    in src/persistence/file-store.ts. The field was defined at line 42 and was
    also being populated in the readLogFile() function at line 221. Both have
    been removed. The codebase now uses only the weatherForecasts array.

================================================================================
LOW PRIORITY
================================================================================

[ ] 9. Remove unused strategy.ts file

    src/strategy.ts is a 1-line stub file that serves no purpose.
    Either implement the intended functionality or delete the file.

--------------------------------------------------------------------------------

[x] 10. Move SettlementEntry interface to types.ts

    COMPLETED: The SettlementEntry interface has been moved from
    monitor-markets.ts to src/persistence/file-store.ts (line 48).
    This is a sensible location since it's closely related to the
    file persistence functionality. It's exported and imported by
    settlement.ts as needed.

--------------------------------------------------------------------------------

[ ] 11. Fix awkward type casting in weather.ts

    Current code uses:
      safeNumber(f?.main?.temp_max, null as unknown as number)

    This is a code smell. Either:
    - Use undefined as the sentinel value
    - Create a safeNumberOrNull variant
    - Handle the nullable case explicitly

--------------------------------------------------------------------------------

[ ] 12. Consider splitting types.ts by domain

    As the codebase grows, types.ts (122 lines) could be split:
    - src/types/weather.ts
    - src/types/market.ts
    - src/types/position.ts
    - src/types/settlement.ts

================================================================================
SUGGESTED FILE STRUCTURE AFTER REFACTORING
================================================================================

src/
├── config/
│   └── constants.ts         # All thresholds, intervals, URLs
├── parsers/
│   └── market-parser.ts     # Question parsing, date extraction
├── positions/
│   ├── position-manager.ts  # Create, close, track positions
│   └── decided-95.ts        # Early close detection logic
├── settlement/
│   └── settlement.ts        # P&L calculation, settlement logging
├── persistence/
│   └── file-store.ts        # All JSON file read/write operations
├── scheduler.ts             # ClockAlignedScheduler class
├── monitor.ts               # Main orchestration (simplified)
├── polymarket.ts            # Polymarket API integration
├── weather.ts               # OpenWeather API integration
├── probability-model.ts     # Statistical probability model
├── api-utils.ts             # Retry logic, safe type helpers
├── types/
│   ├── index.ts             # Re-exports all types
│   ├── weather.ts           # Weather-related interfaces
│   ├── market.ts            # Market/snapshot interfaces
│   ├── position.ts          # Position tracking interfaces
│   └── settlement.ts        # Settlement/P&L interfaces
└── __tests__/
    ├── probability-model.test.ts
    ├── market-parser.test.ts
    ├── position-manager.test.ts
    └── settlement.test.ts

================================================================================
NOTES
================================================================================

- The codebase is functional and has good error handling patterns
- Main issue is concentration of logic in monitor-markets.ts
- Refactoring should be done incrementally to avoid breaking changes
- Consider adding integration tests before major refactoring
- The probability model and API utilities are well-designed and can remain as-is

================================================================================
